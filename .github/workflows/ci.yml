name: CI

on:
  workflow_dispatch:
    inputs:
      publish:
        description: 'Set to "true" to upload built artifacts after successful build'
        required: false
        default: 'false'
      publish_target:
        description: 'Target for publish: pypi or testpypi'
        required: false
        default: 'testpypi'
      python-version:
        description: 'Python version to use for tests/build'
        required: false
        default: '3.13'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ github.event.inputs.python-version }}

      - name: Make scripts executable
        run: chmod +x ./scripts/*.sh || true

      - name: Generate client
        run: ./scripts/generate.sh

      - name: Run tests (tox)
        run: ./scripts/run-tox.sh

      - name: Build package
        run: ./scripts/build-python.sh

      - name: Upload build artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: generated/python-client/dist/*

  publish:
    needs: build
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.publish == 'true' }}
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ github.event.inputs.python-version }}

      - name: Install twine
        run: python -m pip install --upgrade pip && python -m pip install twine

      - name: Check TWINE secrets
        env:
          TWINE_USERNAME: ${{ secrets.TWINE_USERNAME }}
          TWINE_PASSWORD: ${{ secrets.TWINE_PASSWORD }}
        run: |
          if [ -z "$TWINE_USERNAME" ] || [ -z "$TWINE_PASSWORD" ]; then
            echo "TWINE_USERNAME or TWINE_PASSWORD secret is not set. Aborting publish.";
            exit 1
          fi

      - name: Upload to TestPyPI or PyPI
        env:
          TWINE_USERNAME: ${{ secrets.TWINE_USERNAME }}
          TWINE_PASSWORD: ${{ secrets.TWINE_PASSWORD }}
        run: |
          TARGET="${{ github.event.inputs.publish_target }}"
          if [ "$TARGET" = "pypi" ]; then
            python -m twine upload --repository pypi dist/*
          else
            python -m twine upload --repository testpypi dist/*
          fi
